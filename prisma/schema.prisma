/**
 * @file prisma/schema.prisma
 * @description
 * WBS Master 프로젝트의 데이터베이스 스키마 정의 파일입니다.
 * Prisma ORM을 사용하여 Supabase PostgreSQL과 연동합니다.
 *
 * 주요 모델:
 * - User: 사용자 정보 (Supabase Auth 연동)
 * - Project: 프로젝트 정보
 * - Task: 태스크/할일 (칸반 보드용)
 * - Requirement: 요구사항 점검표
 * - Holiday: 휴무 달력
 * - TeamMember: 프로젝트별 팀 멤버
 */

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// 사용자 모델
// 이메일/비밀번호 기반 자체 인증 시스템
// ============================================
model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String   @default("admin123") // 비밀번호 (기본값: admin123)
  name      String?
  avatar    String?  // 프로필 이미지 URL
  role      UserRole @default(MEMBER)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 관계
  ownedProjects Project[]    @relation("ProjectOwner")
  teamMembers   TeamMember[]
  assignedTasks Task[]       @relation("TaskAssignee") // 내가 주 담당자인 태스크들
  taskAssignments TaskAssignee[] // 태스크 부 담당자 (다대다)
  createdTasks  Task[]       @relation("TaskCreator")
  requestedRequirements Requirement[] @relation("RequirementRequester") // 내가 요청한 요구사항
  assignedRequirements  Requirement[] @relation("RequirementAssignee")  // 나에게 할당된 요구사항
  wbsAssignments WbsAssignee[] // WBS 담당자 (다대다)
  reportedIssues Issue[] @relation("IssueReporter") // 내가 보고한 이슈
  assignedIssues Issue[] @relation("IssueAssignee") // 나에게 할당된 이슈
  aiSetting     AiSetting?   // AI 설정 (1:1)
  chatHistories ChatHistory[] // 채팅 기록
  holidays      Holiday[] @relation("HolidayUser") // 개인 일정
  taskNudges    TaskNudge[] @relation("TaskNudger") // 내가 보낸 재촉

  @@map("users")
}

enum UserRole {
  EXECUTIVE    // 경영자
  DIRECTOR     // 총괄
  PMO          // PMO (Project Management Office)
  PM           // PM (Project Manager)
  PL           // PL (Project Leader)
  DEVELOPER    // 개발자
  DESIGNER     // 디자이너
  OPERATOR     // 오퍼레이터
  MEMBER       // 일반 멤버
}

// ============================================
// 프로젝트 모델
// WBS 프로젝트 정보
// ============================================
model Project {
  id          String        @id @default(uuid())
  name        String
  description String?
  status      ProjectStatus @default(PLANNING)
  startDate   DateTime?
  endDate     DateTime?
  progress    Int           @default(0) // 진행률 0-100
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  // 프로젝트 개요 정보
  purpose           String?   // 프로젝트 목적
  organizationChart Json?     // 프로젝트 조직도 (JSON 구조: {role, name, department}[])
  successIndicators String[]  // 성공지표 (문자열 배열)
  futureVision      String?   // 추구하는 미래모습
  visionImage       String?   // 미래 비전 이미지 URL

  // 관계
  ownerId      String
  owner        User          @relation("ProjectOwner", fields: [ownerId], references: [id])
  tasks        Task[]
  requirements Requirement[]
  issues       Issue[]       // 이슈 목록
  teamMembers  TeamMember[]
  holidays     Holiday[]
  wbsItems     WbsItem[]     // WBS 항목
  chatHistories ChatHistory[] // AI 채팅 기록

  @@map("projects")
}

enum ProjectStatus {
  PLANNING   // 계획 중
  ACTIVE     // 진행 중
  ON_HOLD    // 보류
  COMPLETED  // 완료
  CANCELLED  // 취소
}

// ============================================
// 태스크 모델
// 칸반 보드용 태스크/할일
// ============================================
model Task {
  id          String       @id @default(uuid())
  title       String
  description String?
  status      TaskStatus   @default(PENDING)
  priority    TaskPriority @default(MEDIUM)
  startDate   DateTime?    // 시작일
  dueDate     DateTime?    // 마감일
  order       Int          @default(0) // 칸반 보드 내 순서
  isAiGenerated Boolean    @default(false) // AI가 생성한 태스크 여부
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  // 관계
  projectId     String
  project       Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  assigneeId    String?        // 주 담당자 (1:N 관계로 누구의 태스크인지 명확히)
  assignee      User?   @relation("TaskAssignee", fields: [assigneeId], references: [id], onDelete: SetNull)
  assignees     TaskAssignee[] // 부 담당자들 (다대다, 협업자)
  creatorId     String
  creator       User    @relation("TaskCreator", fields: [creatorId], references: [id])
  requirementId String?        // 연결된 요구사항 (선택)
  requirement   Requirement? @relation(fields: [requirementId], references: [id], onDelete: SetNull)
  nudges        TaskNudge[]    // 재촉 목록

  @@map("tasks")
}

// ============================================
// 태스크 담당자 모델 (다대다 조인 테이블)
// 한 태스크에 여러 담당자 지정 가능
// ============================================
model TaskAssignee {
  id         String   @id @default(uuid())
  assignedAt DateTime @default(now()) // 담당자 지정일

  // 관계
  taskId String
  task   Task   @relation(fields: [taskId], references: [id], onDelete: Cascade)
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([taskId, userId]) // 같은 태스크에 같은 사용자는 한 번만
  @@map("task_assignees")
}

// ============================================
// 태스크 재촉 모델
// 다른 사람이 태스크 담당자에게 재촉할 수 있음
// ============================================
model TaskNudge {
  id        String   @id @default(uuid())
  message   String?  // 재촉 메시지 (선택)
  createdAt DateTime @default(now())

  // 관계
  taskId    String
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  nudgerId  String   // 재촉한 사람
  nudger    User     @relation("TaskNudger", fields: [nudgerId], references: [id], onDelete: Cascade)

  @@index([taskId])
  @@index([nudgerId])
  @@map("task_nudges")
}

enum TaskStatus {
  PENDING     // 대기중
  IN_PROGRESS // 진행중
  HOLDING     // 홀딩
  DELAYED     // 지연 (마감일 초과)
  COMPLETED   // 완료
  CANCELLED   // 취소
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
}

// ============================================
// 요구사항 모델
// 요구사항 점검표용
// ============================================
model Requirement {
  id          String              @id @default(uuid())
  code        String?             // 요구사항 코드 (REQ-001 등)
  title       String
  description String?
  status      RequirementStatus   @default(DRAFT)
  priority    RequirementPriority @default(SHOULD)
  category    String?             // 카테고리 (인증, UI/UX, API 등)
  oneDriveLink String?            // OneDrive 문서 링크
  requestDate DateTime            @default(now())  // 요청일
  dueDate     DateTime?           // 마감일
  isDelayed   Boolean             @default(false)  // 지연 여부
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt

  // 관계
  projectId   String
  project     Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  requesterId String?             // 요청자 (누가 요청했는지)
  requester   User?   @relation("RequirementRequester", fields: [requesterId], references: [id])
  assigneeId  String?             // 담당자 (누구에게 요청했는지)
  assignee    User?   @relation("RequirementAssignee", fields: [assigneeId], references: [id])
  tasks       Task[]              // 연결된 태스크들

  @@map("requirements")
}

enum RequirementStatus {
  DRAFT       // 초안
  REVIEW      // 검토중
  APPROVED    // 승인
  REJECTED    // 반려
  IMPLEMENTED // 구현완료
}

enum RequirementPriority {
  MUST   // 필수
  SHOULD // 중요
  COULD  // 선택
  WONT   // 보류
}

// ============================================
// 일정 모델 (휴무 + 개인 일정)
// 일정 관리 달력용
// ============================================
model Holiday {
  id          String      @id @default(uuid())
  title       String
  description String?     // 일정 상세 설명
  date        DateTime
  endDate     DateTime?   // 종료일 (기간 일정용)
  type        HolidayType
  isAllDay    Boolean     @default(true)  // 종일 일정 여부
  startTime   String?     // 시작 시간 (HH:mm 형식)
  endTime     String?     // 종료 시간 (HH:mm 형식)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  // 관계
  projectId   String
  project     Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  userId      String?     // 개인 일정인 경우 사용자 ID
  user        User?   @relation("HolidayUser", fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@map("holidays")
}

enum HolidayType {
  COMPANY_HOLIDAY  // 회사 휴일
  TEAM_OFFSITE     // 팀 오프사이트
  PERSONAL_LEAVE   // 개인 휴가
  PERSONAL_SCHEDULE // 개인 일정
  MEETING          // 회의
  DEADLINE         // 마감일
  OTHER            // 기타
}

// ============================================
// 팀 멤버 모델
// 프로젝트별 팀 멤버 관리
// ============================================
model TeamMember {
  id         String         @id @default(uuid())
  role       TeamMemberRole @default(MEMBER)
  customRole String?        // 커스텀 역할명 (예: PMO, 프로젝트 총괄, PL 등)
  department String?        // 부서 (예: 개발팀, 기획팀, 디자인팀 등)
  position   String?        // 직급 (예: 사원, 대리, 과장, 차장, 부장 등)
  joinedAt   DateTime       @default(now())
  createdAt  DateTime       @default(now())
  updatedAt  DateTime       @updatedAt

  // 관계
  projectId String
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  userId    String
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([projectId, userId]) // 한 프로젝트에 같은 사용자는 한 번만
  @@map("team_members")
}

enum TeamMemberRole {
  OWNER   // 프로젝트 소유자
  MANAGER // 관리자
  MEMBER  // 일반 멤버
}

// ============================================
// WBS 항목 모델
// 계층형 WBS 구조 (대분류 > 중분류 > 소분류 > 단위업무)
// ============================================
model WbsItem {
  id          String        @id @default(uuid())
  code        String        // WBS 코드 (예: 1, 1.1, 1.1.1, 1.1.1.1)
  name        String        // 항목명
  description String?       // 설명
  level       WbsLevel      // 계층 레벨 (1~4)
  order       Int           @default(0) // 같은 레벨 내 순서
  status      TaskStatus    @default(PENDING) // 진행 상태
  progress    Int           @default(0) // 진행률 0-100
  startDate   DateTime?     // 시작일
  endDate     DateTime?     // 종료일
  weight      Int           @default(1) // 가중치 (진행률 계산용)
  deliverableName String?   // 산출물명
  deliverableLink String?   // 산출물 링크 (URL)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  // 계층 관계 (자기 참조)
  parentId    String?
  parent      WbsItem?      @relation("WbsHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children    WbsItem[]     @relation("WbsHierarchy")

  // 프로젝트 관계
  projectId   String
  project     Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)

  // 담당자 (다대다)
  assignees   WbsAssignee[]

  @@unique([projectId, code]) // 프로젝트 내 WBS 코드 유일성
  @@map("wbs_items")
}

// ============================================
// WBS 레벨 Enum
// 4단계 계층 구조
// ============================================
enum WbsLevel {
  LEVEL1  // 대분류 (분석, 설계, 개발, 테스트, 이행)
  LEVEL2  // 중분류
  LEVEL3  // 소분류
  LEVEL4  // 단위업무
}

// ============================================
// WBS 담당자 모델 (다대다 조인 테이블)
// 한 WBS 항목에 여러 담당자 지정 가능
// ============================================
model WbsAssignee {
  id         String   @id @default(uuid())
  assignedAt DateTime @default(now())

  // 관계
  wbsItemId  String
  wbsItem    WbsItem  @relation(fields: [wbsItemId], references: [id], onDelete: Cascade)
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([wbsItemId, userId])
  @@map("wbs_assignees")
}

// ============================================
// 이슈 모델
// 이슈사항 점검표용
// ============================================
model Issue {
  id          String         @id @default(uuid())
  code        String?        // 이슈 코드 (ISS-001 등)
  title       String
  description String?
  status      IssueStatus    @default(OPEN)
  priority    IssuePriority  @default(MEDIUM)
  category    IssueCategory  @default(BUG)
  reportDate  DateTime       @default(now())  // 보고일
  dueDate     DateTime?      // 목표 해결일
  resolvedDate DateTime?     // 실제 해결일
  isDelayed   Boolean        @default(false)  // 지연 여부
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  // 관계
  projectId   String
  project     Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  reporterId  String?        // 보고자 (누가 보고했는지)
  reporter    User?   @relation("IssueReporter", fields: [reporterId], references: [id])
  assigneeId  String?        // 담당자 (누가 처리할지)
  assignee    User?   @relation("IssueAssignee", fields: [assigneeId], references: [id])

  @@map("issues")
}

enum IssueStatus {
  OPEN        // 열림
  IN_PROGRESS // 진행중
  RESOLVED    // 해결됨
  CLOSED      // 종료
  WONT_FIX    // 수정안함
}

enum IssuePriority {
  CRITICAL  // 긴급
  HIGH      // 높음
  MEDIUM    // 보통
  LOW       // 낮음
}

enum IssueCategory {
  BUG           // 버그
  IMPROVEMENT   // 개선
  QUESTION      // 문의
  FEATURE       // 신규기능
  DOCUMENTATION // 문서
  OTHER         // 기타
}

// ============================================
// AI 설정 모델
// LLM API 키 및 모델 설정
// ============================================
model AiSetting {
  id            String   @id @default(uuid())
  userId        String   @unique
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  provider      String   @default("gemini")  // "gemini" | "mistral"
  geminiApiKey  String?  // Google AI Studio API 키
  geminiModel   String   @default("gemini-1.5-flash")
  mistralApiKey String?  // Mistral API 키
  mistralModel  String   @default("mistral-small-latest")

  // 현재 선택된 페르소나
  activePersonaId String?

  // 시스템 프롬프트 (커스터마이징 가능)
  sqlSystemPrompt      String?  // SQL 생성용 시스템 프롬프트
  analysisSystemPrompt String?  // 결과 분석용 시스템 프롬프트

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("ai_settings")
}

// ============================================
// AI 페르소나 모델
// 커스텀 시스템 프롬프트 및 페르소나 관리
// ============================================
model AiPersona {
  id            String   @id @default(uuid())
  userId        String

  name          String          // 페르소나 이름 (예: "PM 어시스턴트", "코드 리뷰어")
  description   String?         // 페르소나 설명
  icon          String?         // 아이콘 (Material Icons 이름)
  systemPrompt  String          // 시스템 프롬프트 (LLM에 전달)
  isDefault     Boolean @default(false) // 기본 페르소나 여부
  isActive      Boolean @default(true)  // 활성화 여부

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([userId])
  @@map("ai_personas")
}

// ============================================
// Slack 설정 모델
// Slack 웹훅 연동 설정
// ============================================
model SlackSettings {
  id              String   @id @default(uuid())
  webhookUrl      String   // Slack 웹훅 URL
  channelName     String?  // 채널 이름 (표시용)
  isEnabled       Boolean  @default(true) // 전체 알림 활성화

  // 알림 조건
  notifyTaskCompleted    Boolean @default(true)  // Task 완료 시
  notifyTaskCreated      Boolean @default(false) // Task 생성 시
  notifyTaskDelayed      Boolean @default(true)  // Task 지연 시
  notifyIssueCreated     Boolean @default(true)  // 이슈 등록 시
  notifyIssueResolved    Boolean @default(false) // 이슈 해결 시
  notifyProjectProgress  Boolean @default(false) // 프로젝트 진행률 변경 시

  // 추가 옵션
  mentionOnUrgent Boolean @default(false) // 긴급 시 @channel 멘션
  dailyReportTime String? // 일일 리포트 시간 (HH:mm 형식, null이면 비활성화)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("slack_settings")
}

// ============================================
// 채팅 기록 모델
// AI 어시스턴트 대화 기록
// ============================================
model ChatHistory {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  projectId   String?
  project     Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)

  role        String   // "user" | "assistant"
  content     String   // 메시지 내용 (마크다운)
  sqlQuery    String?  // 실행된 SQL 쿼리
  chartData   Json?    // 차트 데이터 (JSON)
  chartType   String?  // 차트 타입 (bar, line, pie, mindmap 등)
  mindmapData Json?    // 마인드맵 데이터 (JSON 트리 구조)

  // 분석용 추가 필드
  userQuery        String?  // 원본 사용자 질문 (assistant 메시지에 저장)
  processingTimeMs Int?     // 전체 처리 시간 (ms)
  sqlGenTimeMs     Int?     // SQL 생성 시간 (ms)
  sqlExecTimeMs    Int?     // SQL 실행 시간 (ms)
  personaId        String?  // 사용된 페르소나 ID
  errorMessage     String?  // 에러 발생 시 메시지

  createdAt   DateTime @default(now())

  // 피드백 관계 (1:1)
  feedback    ChatFeedback?

  @@index([userId, projectId])
  @@index([createdAt])
  @@map("chat_histories")
}

// ============================================
// 채팅 피드백 모델
// 사용자가 AI 응답에 대해 피드백을 남김
// 분석용으로 모든 관련 데이터를 독립적으로 저장
// ============================================
model ChatFeedback {
  id              String   @id @default(uuid())

  // 연결 (1:1) - 참조용, ChatHistory 삭제되어도 피드백 데이터는 유지
  chatHistoryId   String?  @unique
  chatHistory     ChatHistory? @relation(fields: [chatHistoryId], references: [id], onDelete: SetNull)

  // 피드백 정보
  rating          FeedbackRating  // POSITIVE, NEGATIVE, NEUTRAL
  comment         String?         // 상세 피드백 (선택)

  // ===== 분석용 데이터 (ChatHistory에서 복사) =====
  // 사용자 질의
  userQuery       String?         // 사용자가 입력한 원본 질문

  // LLM 응답
  llmResponse     String?         // LLM이 생성한 전체 응답 (마크다운)

  // SQL 관련
  sqlQuery        String?         // 생성된 SQL 쿼리

  // 차트/시각화 관련
  chartType       String?         // 차트 타입 (bar, line, pie, mindmap 등)
  chartData       Json?           // 차트 데이터 (JSON)
  mindmapData     Json?           // 마인드맵 데이터 (JSON)

  // 성능 측정
  processingTimeMs Int?           // 전체 처리 시간 (ms)
  sqlGenTimeMs    Int?            // SQL 생성 시간 (ms)
  sqlExecTimeMs   Int?            // SQL 실행 시간 (ms)

  // 컨텍스트 정보
  projectId       String?         // 프로젝트 ID
  projectName     String?         // 프로젝트 이름 (삭제되어도 남음)
  personaId       String?         // 사용된 페르소나 ID
  personaName     String?         // 페르소나 이름 (삭제되어도 남음)

  // 세부 평가 항목 (선택)
  isSqlCorrect    Boolean?        // SQL이 올바르게 생성되었는가
  isResponseHelpful Boolean?      // 응답이 도움이 되었는가
  isChartUseful   Boolean?        // 차트/시각화가 유용했는가

  // 분류 태그 (분석용)
  tags            String[]        // 예: ["SQL오류", "응답부정확", "속도느림"]

  createdAt       DateTime @default(now())

  @@index([rating])
  @@index([createdAt])
  @@index([projectId])
  @@map("chat_feedbacks")
}

enum FeedbackRating {
  POSITIVE  // 좋아요 (도움됨)
  NEGATIVE  // 싫어요 (도움안됨)
  NEUTRAL   // 보통
}
