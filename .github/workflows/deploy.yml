name: Deploy to Windows Server

on:
  push:
    branches: [master]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted

    defaults:
      run:
        working-directory: C:\Project\WBSMaster

    steps:
      - name: Configure Git safe directory
        run: git config --global --add safe.directory C:/Project/WBSMaster

      - name: Stop all Node processes
        run: taskkill /F /IM node.exe /T 2>nul || echo "No node process"
        shell: cmd
        continue-on-error: true

      - name: Pull latest code
        run: |
          git fetch origin master
          git reset --hard origin/master

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma Client
        run: npx prisma generate

      - name: Build
        run: npm run build

      - name: Restart with PM2
        run: pm2 start ecosystem.config.js --update-env
        shell: cmd
